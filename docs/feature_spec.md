# KTX 자동 조회·예약 테스트 앱 - 기능 명세서

## 1. 개요

- **목적**: Flutter + Python FastAPI 기반 KTX 열차 자동 조회 및 예약 시도 자동화 기술 검증
- **대상 사용자**: 개발자 본인 (개인/비배포용)
- **기대 효과**: KTX 비공식 API 활용 가능성 검증, 자동 조회/예약 플로우 학습

---

## 2. 기능 요구사항

### 핵심 기능

| ID | 기능명 | 설명 | 우선순위 |
|----|--------|------|----------|
| FR-001 | 열차 조회 | 출발역/도착역/날짜/시간 기반 KTX 열차 목록 조회 | P0 |
| FR-002 | 자동 새로고침 & 조건 감시 | 설정 조건에 따라 주기적 자동 조회 및 좌석 감시 | P0 |
| FR-003 | 예약 시도 | korail2 비공식 API를 통한 예약 생성 시도 | P0 |
| FR-004 | 예약 결과 처리 | 예약 성공/실패 결과 표시 및 로그 기록 | P0 |
| FR-005 | 로그인/세션 관리 | 코레일 계정 로그인 및 세션 유지 | P0 |
| FR-006 | 로그 뷰어 | 조회/예약 시도 이력 로그 표시 | P1 |

### 비기능 요구사항

| 항목 | 요구사항 |
|------|----------|
| 성능 | 요청 주기 최소 5~10초, 단일 사용자 기준 |
| 보안 | 계정 정보 .env 관리, 하드코딩 금지 |
| 안정성 | exponential backoff (5s → 10s → 20s → 60s max) |
| 차단 방지 | 일일 요청 제한, 실패 시 자동 백오프 |
| 플랫폼 | iOS/Android (Flutter), 로컬 서버 (Python) |

---

## 3. 기능 상세 명세

### FR-001: 열차 조회

| 항목 | 내용 |
|------|------|
| 기능명 | 열차 조회 |
| 설명 | 사용자가 입력한 출발역/도착역/날짜/시간 조건으로 KTX 열차 목록을 조회한다 |
| 입력 | 출발역(String), 도착역(String), 날짜(YYYYMMDD), 시간(HHmmss) |
| 출력 | 열차 목록: [{train_no, dep_time, arr_time, train_type, seats_available}] |
| 사전조건 | Backend 서버 실행 중, 코레일 로그인 완료 |
| 사후조건 | 열차 목록이 UI에 표시됨 |
| 기술 스택 | Flutter(dio) → FastAPI → korail2.search_train() |
| 에러 케이스 | 네트워크 오류, 코레일 서버 장애, 세션 만료, 잘못된 역명, 해당 열차 없음 |

### FR-002: 자동 새로고침 & 조건 감시

| 항목 | 내용 |
|------|------|
| 기능명 | 자동 새로고침 & 조건 감시 |
| 설명 | 사용자가 설정한 조건(날짜/시간대/열차종류)에 맞는 열차를 주기적으로 자동 조회하며, 좌석이 확인되면 예약을 시도한다 |
| 입력 | 검색 조건(출발역/도착역/날짜/시간), 자동예약 ON/OFF, 조회 주기(초) |
| 출력 | 실시간 상태(조회중/좌석없음/예약시도중/성공/실패), 조회 횟수, 마지막 조회 시간 |
| 사전조건 | 검색 조건이 설정됨, 자동 예약 모드 ON |
| 사후조건 | 좌석 발견 시 자동으로 FR-003(예약 시도) 트리거 |
| 기술 스택 | Flutter Timer.periodic → Backend polling API |
| 에러 케이스 | 연속 실패 시 백오프 적용, 네트워크 단절 시 일시 정지, 앱 백그라운드 전환 시 타이머 정지 |

### FR-003: 예약 시도

| 항목 | 내용 |
|------|------|
| 기능명 | 예약 시도 |
| 설명 | korail2 비공식 API를 통해 선택된 열차의 예약을 생성한다 (결제 미포함) |
| 입력 | train_no(열차번호), session_token(로그인 세션) |
| 출력 | {reservation_id, status("success"/"failure"), train_info, message} |
| 사전조건 | 코레일 로그인 완료, 조회된 열차 존재 |
| 사후조건 | 예약 성공 시 예약번호 발급, 실패 시 사유 기록 |
| 기술 스택 | FastAPI → korail2.reserve(train) |
| 에러 케이스 | 이미 매진, 세션 만료(→ 자동 재로그인 후 재시도), korail2 API 변경으로 실패, 예약 한도 초과 |

### FR-004: 예약 결과 처리

| 항목 | 내용 |
|------|------|
| 기능명 | 예약 결과 처리 |
| 설명 | 예약 시도의 결과를 사용자에게 표시하고 이력을 기록한다 |
| 입력 | 예약 시도 응답 (reservation_id, status, train_info, message) |
| 출력 | 성공: 예약번호 + 열차정보 + "결제 필요" 안내 카드 / 실패: 실패 사유 + 재시도 버튼 |
| 사전조건 | FR-003 예약 시도 완료 |
| 사후조건 | 결과가 UI에 표시되고 로그에 기록됨 |
| 기술 스택 | Flutter Riverpod 상태관리 + UI 카드 위젯 |
| 에러 케이스 | 결과 수신 타임아웃, 알 수 없는 상태 코드 |

### FR-005: 로그인/세션 관리

| 항목 | 내용 |
|------|------|
| 기능명 | 로그인/세션 관리 |
| 설명 | 코레일 계정으로 로그인하고 세션을 유지한다. 세션 만료 시 자동 재로그인한다 |
| 입력 | 코레일 ID, 비밀번호 (Backend .env에서 관리) |
| 출력 | {session_token, expires_at, login_status} |
| 사전조건 | 유효한 코레일 계정 존재 |
| 사후조건 | 세션 토큰 발급, 이후 API 호출에 사용 |
| 기술 스택 | FastAPI → korail2.Korail(ID, PW) |
| 에러 케이스 | 잘못된 계정정보, 계정 차단/제한, 코레일 서버 장애 |

### FR-006: 로그 뷰어

| 항목 | 내용 |
|------|------|
| 기능명 | 로그 뷰어 |
| 설명 | 조회/예약 시도 이력을 시간순으로 표시한다 |
| 입력 | 없음 (자동 수집) |
| 출력 | 로그 리스트: [{timestamp, action, result, detail}] |
| 사전조건 | 앱 실행 중 |
| 사후조건 | 최근 로그가 화면에 표시됨 |
| 기술 스택 | Flutter ListView + 메모리 내 로그 버퍼 |
| 에러 케이스 | 로그 과다 시 오래된 항목 자동 삭제 (최대 500건) |

---

## 4. 사용자 시나리오

### 메인 시나리오: 자동 조회 → 예약

```
1. [설정 화면] 사용자가 출발역(서울), 도착역(부산), 날짜(2026-02-05), 시간(09:00) 입력
2. [설정 화면] "자동 예약" 토글 ON
3. [설정 화면] "조회 시작" 버튼 탭
4. [모니터 화면] 자동으로 전환, 상태: "조회 중..."
5. [모니터 화면] Backend로 열차 조회 요청 전송 (5초 주기)
6. [모니터 화면] 조회 횟수, 마지막 조회 시간 업데이트
7. [모니터 화면] 좌석 있는 열차 발견 → 상태: "예약 시도 중..."
8. [모니터 화면] Backend에서 korail2.reserve() 호출
9. [결과 화면] 자동으로 전환
   - 성공: 예약번호, 열차정보, "10분 내 결제 필요" 안내
   - 실패: 실패 사유, "재시도" 버튼
10. [결과 화면] 로그에 전체 과정 기록
```

### 대체 시나리오

| 시나리오 | 분기 지점 | 처리 |
|---------|----------|------|
| 열차 없음 | Step 6 | "해당 조건의 열차가 없습니다" 표시, 조건 변경 유도 |
| 좌석 없음 (지속) | Step 6 | 계속 자동 조회, 로그에 "좌석 없음" 기록 |
| 네트워크 오류 | Step 5 | 백오프 적용, "네트워크 오류 - 재시도 중" 표시 |
| 세션 만료 | Step 8 | 자동 재로그인 후 재시도 |
| 예약 실패 (매진) | Step 8 | 자동 조회 모드로 복귀, 계속 감시 |
| 앱 백그라운드 | 아무 때나 | 타이머 일시 정지, 포그라운드 복귀 시 재개 |

---

## 5. 상태 전이도

```
                          ┌─────────────┐
                          │    idle      │ ← 초기 상태
                          └──────┬──────┘
                                 │ "조회 시작" 버튼
                                 ▼
                          ┌─────────────┐
                     ┌──→ │  searching   │ ◀─────────────────┐
                     │    └──────┬──────┘                    │
                     │           │ 열차 발견 (좌석 있음)       │
                     │           ▼                           │
                     │    ┌─────────────┐                    │
                     │    │   found      │                   │
                     │    └──────┬──────┘                    │
                     │           │ 자동예약 ON                │
                     │           ▼                           │
                     │    ┌─────────────┐                    │
                     │    │  reserving   │                   │
                     │    └──────┬──────┘                    │
                     │           │                           │
                     │     ┌─────┴─────┐                    │
                     │     ▼           ▼                    │
                     │ ┌────────┐ ┌────────┐                │
                     │ │success │ │failure │────────────────┘
                     │ └───┬────┘ └────────┘  (자동 재시도 시)
                     │     │
                     │     │ "완료" 또는 수동 정지
                     │     ▼
                     │ ┌─────────────┐
                     └─│    idle      │
                       └─────────────┘
```

### 상태 정의

| 상태 | 설명 | UI 표시 |
|------|------|---------|
| `idle` | 대기 상태, 조회 미시작 | 회색, "대기 중" |
| `searching` | 열차 조회 진행 중 | 파랑, 로딩 스피너 |
| `found` | 좌석 있는 열차 발견 | 초록, 열차 정보 표시 |
| `reserving` | 예약 시도 진행 중 | 주황, "예약 중..." |
| `success` | 예약 성공 | 초록 체크, 예약번호 표시 |
| `failure` | 예약 실패 | 빨강 X, 실패 사유 표시 |

---

## 6. 데이터 모델

### Train (열차 정보)
```
{
  train_no: String        // 열차번호 (예: "KTX-101")
  train_type: String      // 열차 종류 (예: "KTX")
  dep_station: String     // 출발역
  arr_station: String     // 도착역
  dep_time: String        // 출발 시간 (HH:mm)
  arr_time: String        // 도착 시간 (HH:mm)
  seats_available: bool   // 좌석 여부
  special_seats: bool     // 특실 여부
  general_seats: bool     // 일반실 여부
}
```

### SearchCondition (검색 조건)
```
{
  dep_station: String     // 출발역
  arr_station: String     // 도착역
  date: String            // 날짜 (YYYYMMDD)
  time: String            // 시간 (HHmmss)
  train_type: String      // 열차 종류 (기본: "KTX")
  auto_reserve: bool      // 자동 예약 여부
  refresh_interval: int   // 조회 주기 (초, 기본: 10)
}
```

### Reservation (예약 정보)
```
{
  reservation_id: String  // 예약번호
  status: String          // "success" | "failure"
  train: Train            // 예약된 열차 정보
  message: String         // 결과 메시지
  reserved_at: DateTime   // 예약 시각
}
```

### LogEntry (로그 항목)
```
{
  timestamp: DateTime     // 시각
  action: String          // "search" | "reserve" | "login" | "error"
  result: String          // "success" | "failure" | "no_seats"
  detail: String          // 상세 메시지
}
```

---

## 7. 예외 처리

| 상황 | 처리 방법 |
|------|----------|
| 네트워크 오류 | exponential backoff 적용 (5s → 10s → 20s → 60s), 상태바에 "오프라인" 표시 |
| 코레일 서버 장애 | 30초 대기 후 재시도, 3회 실패 시 자동 조회 일시 정지 |
| 세션 만료 | 자동 재로그인 시도, 실패 시 사용자에게 알림 |
| 잘못된 역명 입력 | 프론트엔드에서 역명 자동완성/드롭다운으로 방지 |
| korail2 API 변경 | 상세 에러 로그 기록, 사용자에게 "API 오류" 알림 |
| 계정 차단/제한 | 즉시 자동 조회 중단, "계정 제한" 경고 표시 |
| 요청 한도 초과 | 자동 백오프 주기 증가, 일일 한도 카운터 표시 |
| 앱 백그라운드 전환 | Timer 일시 정지, WidgetsBindingObserver로 lifecycle 관리 |
